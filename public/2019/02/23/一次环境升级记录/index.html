<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>一次lnmp环境升级记录 | MagicYou</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.3.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">一次lnmp环境升级记录</h1><a id="logo" href="/.">MagicYou</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/tags/"><i class="fa fa-tag"> 标签</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">一次lnmp环境升级记录</h1><div class="post-meta">Feb 23, 2019<span> | </span><span class="category"><a href="/categories/Linux/">Linux</a></span></div><div class="post-content"><p>集团内部要对所有服务器进行版本升级，因此代码要迁移，环境要搭建<br><a id="more"></a></p>
<h3 id="环境变化"><a href="#环境变化" class="headerlink" title="环境变化"></a>环境变化</h3><h4 id="现役环境："><a href="#现役环境：" class="headerlink" title="现役环境："></a>现役环境：</h4><table>
<thead>
<tr>
<th style="text-align:center">服务器版本</th>
<th style="text-align:center">PHP</th>
<th style="text-align:center">Nginx</th>
<th style="text-align:center">Apache</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">centos 6.8</td>
<td style="text-align:center">php5.6</td>
<td style="text-align:center">nginx/1.12.0</td>
<td style="text-align:center">Apache/2.2.15 (Unix)</td>
</tr>
</tbody>
</table>
<h4 id="升级后环境："><a href="#升级后环境：" class="headerlink" title="升级后环境："></a>升级后环境：</h4><table>
<thead>
<tr>
<th style="text-align:center">服务器版本</th>
<th style="text-align:center">PHP</th>
<th style="text-align:center">Nginx</th>
<th style="text-align:center">Apache</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">centos 7.4</td>
<td style="text-align:center">php5.6</td>
<td style="text-align:center">nginx/1.15.10</td>
<td style="text-align:center">Apache/2.4.6 (CentOS)</td>
</tr>
</tbody>
</table>
<h3 id="相关路径记录"><a href="#相关路径记录" class="headerlink" title="相关路径记录"></a>相关路径记录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">nginx路径</span><br><span class="line">/usr/local/nginx</span><br><span class="line"></span><br><span class="line">php路径</span><br><span class="line">/usr/local/php56/</span><br><span class="line"></span><br><span class="line">php.ini和php-fpm.conf路径</span><br><span class="line">/usr/local/php56/etc</span><br><span class="line"></span><br><span class="line">Php扩展路径</span><br><span class="line">/usr/local/php56/include/php/ext</span><br><span class="line">/usr/local/php56/lib/php/extensions</span><br></pre></td></tr></table></figure>
<h3 id="安装记录"><a href="#安装记录" class="headerlink" title="安装记录"></a>安装记录</h3><h5 id="1-安装nginx"><a href="#1-安装nginx" class="headerlink" title="1. 安装nginx"></a>1. 安装nginx</h5><p>1.检查并安装Nginx基础依赖包pcre-devel   openssl-devel<br>名称中带有”devel”字符串的软件包是必须要安装的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[appuser@xxxxx ~]# rpm -qa openssl-devel openssl</span><br><span class="line">openssl-1.0.2k-8.el7.x86_64</span><br><span class="line">[appuser@xxxxx ~]# rpm -qa pcre-devel pcre</span><br><span class="line">pcre-8.32-17.el7.x86_64</span><br></pre></td></tr></table></figure></p>
<p>2.安装pcre-devel以及openssl-devel<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># yum install -y openssl-devel pcre-devel</span><br></pre></td></tr></table></figure></p>
<p>安装后查看下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[appuser@xxxxx~]# rpm -qa openssl-devel openssl</span><br><span class="line">openssl-1.0.2k-8.el7.x86_64</span><br><span class="line">openssl-devel-1.0.2k-8.el7.x86_64</span><br><span class="line">[appuser@xxxxx~]# rpm -qa pcre-devel pcre</span><br><span class="line">pcre-devel-8.32-17.el7.x86_64</span><br><span class="line">pcre-8.32-17.el7.x86_64</span><br></pre></td></tr></table></figure></p>
<p>3.开始安装Nginx：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># mkdir /usr/local/nginx</span><br></pre></td></tr></table></figure>
<p>进入目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># cd /usr/local/nginx</span><br></pre></td></tr></table></figure>
<p> 下载软件包，进入<a href="http://nginx.org/download/复制对应版本的下载链接地址。" target="_blank" rel="noopener">http://nginx.org/download/复制对应版本的下载链接地址。</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># wget http://nginx.org/download/nginx-1.15.10.tar.gz</span><br></pre></td></tr></table></figure></p>
<p>解压安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[appuser@xxxxx nginx]# ls -l nginx-1.15.10.tar.gz</span><br><span class="line">-rw-r--r-- 1 root root 981687 Oct 17 21:20 nginx-1.15.10.tar.gz</span><br><span class="line">[appuser@xxxxx nginx]# useradd -M -s /sbin/nologin nginx </span><br><span class="line">[appuser@xxxxx nginx]# tar zxf nginx-1.15.10.tar.gz  </span><br><span class="line">[appuser@xxxxx nginx]# cd nginx-1.15.10/</span><br></pre></td></tr></table></figure></p>
<p>安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># ./configure --prefix=/usr/local/nginx --with-http_dav_module --with-http_stub_status_module  --with-http_addition_module --with-http_sub_module  --with-http_flv_module --with-http_mp4_module --with-pcre --with-http_ssl_module --with-http_gzip_static_module  --user=nginx  --group=nginx</span><br><span class="line"># make &amp;&amp; make install</span><br></pre></td></tr></table></figure></p>
<p>安装完成后的优化：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ln -s /usr/local/nginx/sbin/nginx /usr/local/sbin/</span><br></pre></td></tr></table></figure></p>
<p>启动Nginx<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># nginx</span><br></pre></td></tr></table></figure></p>
<p>查看<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># netstat -anput | grep nginx</span><br><span class="line"># ps -ef | grep nginx</span><br></pre></td></tr></table></figure></p>
<p>停止<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nginx -s stop   # 关闭</span><br><span class="line">nginx -s quit   # 退出（也是关闭）</span><br><span class="line">nginx -s reload   # 重新加载配置文件</span><br><span class="line">nginx -s reopen   # 重新打开日志文件</span><br><span class="line">nginx -t          # 测试配置文件</span><br></pre></td></tr></table></figure></p>
<h5 id="2-安装php，php-fpm"><a href="#2-安装php，php-fpm" class="headerlink" title="2. 安装php，php-fpm"></a>2. 安装php，php-fpm</h5><h6 id="yum安装php5-6"><a href="#yum安装php5-6" class="headerlink" title="yum安装php5.6"></a>yum安装php5.6</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># yum install --enablerepo=remi --enablerepo=remi-php56 php php-opcache php-devel php-mbstring php-mcrypt php-mysqlnd php-phpunit-PHPUnit php-pecl-xdebug php-pecl-xhprof -y</span><br></pre></td></tr></table></figure>
<p>查看php版本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># php --version</span><br><span class="line"></span><br><span class="line">[appuser@xxxx /]$ php -v</span><br><span class="line">PHP 5.6.0 (cli) (built: Apr  9 2019 16:00:50)</span><br><span class="line">Copyright (c) 1997-2014 The PHP Group</span><br><span class="line">Zend Engine v2.6.0, Copyright (c) 1998-2014 Zend Technologies</span><br></pre></td></tr></table></figure></p>
<p>测试php-fpm</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># netstat -lnt | grep 9000</span><br></pre></td></tr></table></figure>
<h6 id="安装php扩展"><a href="#安装php扩展" class="headerlink" title="安装php扩展"></a>安装php扩展</h6><p>pgsql 扩展</p>
<p>找到相应的版本 php 5.6.0  <a href="https://www.php.net/releases/" target="_blank" rel="noopener">https://www.php.net/releases/</a></p>
<p>1、从php官网下载一个合适版本的php;<br>2、从PHP解压包里ext目录找到pdo_pgsql 和 pgsql目录，并且复制放到liunx的 /root 目录（随便一个）<br>3、分别进入pdo_pgsql 和 pgsql目录 ：<br>phpize<br>./configure    (./configure –with-php-config=/usr/local/php56/bin/php-config)<br>make </p>
<p> make install</p>
<p>Ps：这里不要直接make &amp;&amp; make install，可能会报错，很抓狂</p>
<p>4、修改php配置文件php.ini，添加pgsql.so、pdo_pgsql.so模块。<br>extension=pgsql.so</p>
<p>5、重启php-fpm</p>
<p>pdo_pgsql 扩展<br>按照相同的办法，安装 pdo_pgsql<br>还有php配置文件php.ini添加<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extension=pdo_pgsql.so</span><br></pre></td></tr></table></figure></p>
<p>安装pgsql扩展时候报错如下： （不知道啥情况，先放着）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Installing shared extensions:     /usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/</span><br><span class="line">cp: cannot create regular file &apos;/usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/#INST@558502#&apos;: Permission denied</span><br><span class="line">make: *** [install-modules] 错误 1</span><br></pre></td></tr></table></figure>
<p><img src="/Users/magicyou/Library/Application Support/typora-user-images/image-20190410131947892.png" alt="image-20190410131947892"></p>
<h4 id="基本完成，配置nginx并上传代码"><a href="#基本完成，配置nginx并上传代码" class="headerlink" title="基本完成，配置nginx并上传代码"></a>基本完成，配置nginx并上传代码</h4><p>1.创建项目文件夹<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /</span><br><span class="line">mkdir www</span><br><span class="line">cd www</span><br><span class="line">mkdir web-osp</span><br><span class="line">chmod -R 777 web-osp</span><br></pre></td></tr></table></figure></p>
<p>代码用命令行或者工具同步进服务器对应文件夹</p>
<p>2.修改配置文件nginx.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">#user  nobody;</span><br><span class="line">worker_processes  4;</span><br><span class="line"></span><br><span class="line">#error_log  logs/error.log;</span><br><span class="line">#error_log  logs/error.log  notice;</span><br><span class="line">#error_log  logs/error.log  info;</span><br><span class="line"></span><br><span class="line">#pid        logs/nginx.pid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line">    underscores_in_headers on;</span><br><span class="line"></span><br><span class="line">    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class="line">    log_format addHeaderlog &apos;$remote_addr - $remote_user [$time_local] &apos;</span><br><span class="line">                    &apos;&quot;$request&quot; $status $body_bytes_sent &apos;</span><br><span class="line">                    &apos;&quot;$http_referer&quot; &quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot; [&quot;$http_oam_uid&quot;]&apos;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    access_log  logs/access.log  addHeaderlog;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    #keepalive_timeout  0;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line">    fastcgi_connect_timeout 300s;</span><br><span class="line">    fastcgi_send_timeout 300s;</span><br><span class="line">    fastcgi_read_timeout 300s;</span><br><span class="line">    fastcgi_buffer_size 128k;</span><br><span class="line">    fastcgi_buffers 8 128k;#8 128</span><br><span class="line">    fastcgi_busy_buffers_size 256k;</span><br><span class="line">    fastcgi_temp_file_write_size 256k;</span><br><span class="line">    fastcgi_intercept_errors on;</span><br><span class="line">    #gzip  on;</span><br><span class="line"> </span><br><span class="line">    server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">        server_name test.data.com.cn;</span><br><span class="line">        location / &#123;</span><br><span class="line">             proxy_pass http://10.0.xx.x:9010/;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line"></span><br><span class="line">    include conf.d/*.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>编辑conf.d文件夹下的配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       9010;</span><br><span class="line">    server_name  127.0.0.1;</span><br><span class="line">    root   &quot;/www/web-ceshi&quot;;</span><br><span class="line">    index  index.html index.htm index.php info.php;</span><br><span class="line">    location / &#123;</span><br><span class="line">       try_files $uri @rewrite;</span><br><span class="line">       proxy_set_header OAM_UID $http_OAM_UID;</span><br><span class="line">       proxy_pass_request_headers      on;</span><br><span class="line">    &#125;</span><br><span class="line">    location @rewrite &#123;</span><br><span class="line">        set $static 0;</span><br><span class="line">        if  ($uri ~ \.(css|js|jpg|jpeg|png|gif|ico|woff|eot|svg|css\.map|min\.map)$) &#123;</span><br><span class="line">            set $static 1;</span><br><span class="line">        &#125;</span><br><span class="line">        if ($static = 0) &#123;</span><br><span class="line">            rewrite ^/(.*)$ /index.php?s=/$1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ /Uploads/.*\.php$ &#123;</span><br><span class="line">        deny all;</span><br><span class="line">    &#125;</span><br><span class="line">    location ~ \.php/ &#123;</span><br><span class="line">       if ($request_uri ~ ^(.+\.php)(/.+?)($|\?)) &#123; &#125;</span><br><span class="line">       fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">       include fastcgi_params;</span><br><span class="line">       fastcgi_param SCRIPT_NAME     $1;</span><br><span class="line">       fastcgi_param PATH_INFO       $2;</span><br><span class="line">       fastcgi_param SCRIPT_FILENAME $document_root$1;</span><br><span class="line">    &#125;</span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">    location ~ /\.ht &#123;</span><br><span class="line">        deny  all;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>重启php-fpm、nginx</p>
<h4 id="部署基本完毕，尝试进入项目，出现两次502，记录如下"><a href="#部署基本完毕，尝试进入项目，出现两次502，记录如下" class="headerlink" title="部署基本完毕，尝试进入项目，出现两次502，记录如下"></a>部署基本完毕，尝试进入项目，出现两次502，记录如下</h4><h5 id="第一次-502-Bad-Gateway"><a href="#第一次-502-Bad-Gateway" class="headerlink" title="第一次  502 Bad Gateway"></a>第一次  502 Bad Gateway</h5><p>nginx配置和php-fpm端口不一致，改好，能登录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastcgi_pass 127.0.0.1:9000;</span><br></pre></td></tr></table></figure></p>
<h5 id="第二次-502-Bad-Gateway"><a href="#第二次-502-Bad-Gateway" class="headerlink" title="第二次  502 Bad Gateway"></a>第二次  502 Bad Gateway</h5><p>登录后进入主页 502</p>
<p>查找问题</p>
<p><a href="https://host.zzidc.com/wljc/928.html" target="_blank" rel="noopener">https://host.zzidc.com/wljc/928.html</a></p>
<p>查看是否是php-fpm的问题，找到正在使用的配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[appuser@XXXXX lib]$ ps -ef | grep php-fpm</span><br><span class="line">root     13824     1  0  2018 ?        00:17:16 php-fpm: master process (/usr/local/etc/php-fpm.conf)</span><br><span class="line">www      18922 13824  0 12:48 ?        00:00:01 php-fpm: pool www</span><br><span class="line">www      24891 13824  0 14:08 ?        00:00:01 php-fpm: pool www</span><br><span class="line">www      25449 13824  0 14:15 ?        00:00:00 php-fpm: pool www</span><br><span class="line">appuser  28587 25750  0 14:46 pts/1    00:00:00 grep php-fpm</span><br></pre></td></tr></table></figure>
<p>编辑php-fpm.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># /usr/local/php/etc/php-fpm.conf</span><br></pre></td></tr></table></figure></p>
<p>没有 php-fpm.conf 的话<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># cp php-fpm.conf.default php-fpm.conf</span><br></pre></td></tr></table></figure></p>
<p>设置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">request_terminate_timeout</span><br><span class="line"></span><br><span class="line">request_terminate_timeout = 600</span><br></pre></td></tr></table></figure></p>
<p>重启php-fpm，还是不行</p>
<p>去看php-fpm日志记录，发现日志没开，先打开日志记录</p>
<ul>
<li>1.修改php-fpm.conf中的配置**，如果没有请增加:</li>
</ul>
<p>复制代码 代码如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">error_log = log/php_error_log</span><br><span class="line">[www]</span><br><span class="line">catch_workers_output = yes</span><br></pre></td></tr></table></figure></p>
<ul>
<li>2.修改php.ini中配置</li>
</ul>
<p>，没有则增加:</p>
<p>复制代码 代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">log_errors = On</span><br><span class="line">error_log = &quot;/usr/local/php/var/log/error_log&quot;</span><br><span class="line">error_reporting=E_ALL&amp;~E_NOTICE</span><br></pre></td></tr></table></figure>
<ul>
<li>3.重启php-fpm</li>
</ul>
<p>当PHP执行错误时就能看到错误日志在”/usr/local/php56/var/log/php_error_log”中了</p>
<ul>
<li>4.浏览器进项目，然后查看看日志</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># /usr/local/php56/var/log/php_error_log</span><br><span class="line">[10-Apr-2019 15:30:58] WARNING: [pool www] child 272566 said into stderr: &quot;php-fpm: pool www: symbol lookup error: /usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/pgsql.so: undefined symbol: _safe_emalloc_string&quot;</span><br></pre></td></tr></table></figure>
<p>重新装pgsql扩展<br>安装的时候不要make &amp;&amp; make install<br>先 make， 然后make install</p>
<h3 id="刷新网页"><a href="#刷新网页" class="headerlink" title="刷新网页"></a>刷新网页</h3><h1 id="Call-to-undefined-function-bcdiv"><a href="#Call-to-undefined-function-bcdiv" class="headerlink" title="Call to undefined function bcdiv()"></a>Call to undefined function bcdiv()</h1><p>继续填坑</p>
<p>查找问题，没有安装扩展bcmath</p>
<p>同安装pgsql一样，安装后基本没发现其他问题</p>
<p>后续配置Apache，ldap集团单点登录</p>
<h3 id="Apache的单点登录配置简单预热，详细看下一篇"><a href="#Apache的单点登录配置简单预热，详细看下一篇" class="headerlink" title="Apache的单点登录配置简单预热，详细看下一篇"></a>Apache的单点登录配置简单预热，详细看下一篇</h3><p>cd /etc/httpd/conf/</p>
<p>sudo vim httpd-vhosts.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;VirtualHost *:9008&gt;</span><br><span class="line">ServerAdmin jituan-web-osp</span><br><span class="line">DocumentRoot &quot;/www/jituan-web&quot;</span><br><span class="line">ServerName jituan-web-osp</span><br><span class="line">ServerAlias jituan-web-osp</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>
<p>查看httpd进程</p>
<p>ps -ef | grep httpd</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">第一、启动、终止、重启</span><br><span class="line"></span><br><span class="line">systemctl start httpd.service #启动</span><br><span class="line"></span><br><span class="line">systemctl stop httpd.service #停止</span><br><span class="line"></span><br><span class="line">systemctl restart httpd.service #重启</span><br></pre></td></tr></table></figure>
<p>启动报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">appuser@xxxx conf]$ sudo systemctl status httpd.service</span><br><span class="line">● httpd.service - The Apache HTTP Server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/httpd.service; disabled; vendor preset: disabled)</span><br><span class="line">   Active: failed (Result: exit-code) since 三 2019-04-10 17:18:23 CST; 10min ago</span><br><span class="line">     Docs: man:httpd(8)</span><br><span class="line">           man:apachectl(8)</span><br><span class="line">  Process: 604898 ExecStop=/bin/kill -WINCH $&#123;MAINPID&#125; (code=exited, status=1/FAILURE)</span><br><span class="line">  Process: 604895 ExecStart=/usr/sbin/httpd $OPTIONS -DFOREGROUND (code=exited, status=1/FAILURE)</span><br><span class="line"> Main PID: 604895 (code=exited, status=1/FAILURE)</span><br><span class="line"></span><br><span class="line">4月 10 17:18:23 xxxx systemd[1]: Starting The Apache HTTP Server...</span><br><span class="line">4月 10 17:18:23 xxxx httpd[604895]: (98)Address already in use: AH00072: make_sock: could not bind to address 0.0.0.0:80</span><br><span class="line">4月 10 17:18:23 xxxx httpd[604895]: no listening sockets available, shutting down</span><br><span class="line">4月 10 17:18:23 xxxx httpd[604895]: AH00015: Unable to open logs</span><br><span class="line">4月 10 17:18:23 xxxx systemd[1]: httpd.service: main process exited, code=exited, status=1/FAILURE</span><br><span class="line">4月 10 17:18:23 xxxx kill[604898]: kill: cannot find process &quot;&quot;</span><br><span class="line">4月 10 17:18:23 xxxx systemd[1]: httpd.service: control process exited, code=exited status=1</span><br><span class="line">4月 10 17:18:23 xxxx systemd[1]: Failed to start The Apache HTTP Server.</span><br><span class="line">4月 10 17:18:23 xxxx systemd[1]: Unit httpd.service entered failed state.</span><br><span class="line">4月 10 17:18:23 xxxx systemd[1]: httpd.service failed.</span><br></pre></td></tr></table></figure>
<p>更根据上面的信息</p>
<p>修改端口80为9008</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[appuser@xxxx /]$ sudo systemctl restart httpd.service</span><br><span class="line">您在 /var/spool/mail/appuser 中有新邮件</span><br><span class="line">[appuser@xxxx /]$ sudo systemctl status httpd.service</span><br><span class="line">● httpd.service - The Apache HTTP Server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/httpd.service; disabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since 三 2019-04-10 17:35:06 CST; 8s ago</span><br><span class="line">     Docs: man:httpd(8)</span><br><span class="line">           man:apachectl(8)</span><br><span class="line">  Process: 604898 ExecStop=/bin/kill -WINCH $&#123;MAINPID&#125; (code=exited, status=1/FAILURE)</span><br><span class="line"> Main PID: 654829 (httpd)</span><br><span class="line">   Status: &quot;Processing requests...&quot;</span><br><span class="line">   CGroup: /system.slice/httpd.service</span><br><span class="line">           ├─654829 /usr/sbin/httpd -DFOREGROUND</span><br><span class="line">           ├─654834 /usr/sbin/httpd -DFOREGROUND</span><br><span class="line">           ├─654835 /usr/sbin/httpd -DFOREGROUND</span><br><span class="line">           ├─654836 /usr/sbin/httpd -DFOREGROUND</span><br><span class="line">           ├─654837 /usr/sbin/httpd -DFOREGROUND</span><br><span class="line">           └─654838 /usr/sbin/httpd -DFOREGROUND</span><br><span class="line"></span><br><span class="line">4月 10 17:35:06 xxxx systemd[1]: Starting The Apache HTTP Server...</span><br><span class="line">4月 10 17:35:06 xxxx systemd[1]: Started The Apache HTTP Server.</span><br></pre></td></tr></table></figure>
</div><div class="tags"><a href="/tags/Linux/">Linux</a><a href="/tags/PHP/">PHP</a><a href="/tags/Centos/">Centos</a><a href="/tags/Nginx/">Nginx</a><a href="/tags/Apache/">Apache</a></div><div class="post-nav"><a class="pre" href="/2019/02/24/单点登录配置 记录/">配置webgate拦截跳转到ldap登录页实现单点登录</a><a class="next" href="/2019/02/03/yum源的代理设置及修改/">yum源的代理设置及修改</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://blog.magicyou.cn"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/MacOS/">MacOS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/PHP/">PHP</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端/">前端</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/vue/" style="font-size: 15px;">vue</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/CSS3/" style="font-size: 15px;">CSS3</a> <a href="/tags/Vue/" style="font-size: 15px;">Vue</a> <a href="/tags/PHP/" style="font-size: 15px;">PHP</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/微信小程序/" style="font-size: 15px;">微信小程序</a> <a href="/tags/Centos/" style="font-size: 15px;">Centos</a> <a href="/tags/other/" style="font-size: 15px;">other</a> <a href="/tags/jQuery/" style="font-size: 15px;">jQuery</a> <a href="/tags/scrapy/" style="font-size: 15px;">scrapy</a> <a href="/tags/HTML5/" style="font-size: 15px;">HTML5</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/Apache/" style="font-size: 15px;">Apache</a> <a href="/tags/MacOS/" style="font-size: 15px;">MacOS</a> <a href="/tags/CSS/" style="font-size: 15px;">CSS</a> <a href="/tags/HTML/" style="font-size: 15px;">HTML</a> <a href="/tags/uni-app/" style="font-size: 15px;">uni-app</a> <a href="/tags/微信小程序/" style="font-size: 15px;">微信小程序'</a> <a href="/tags/canvas/" style="font-size: 15px;">canvas</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/09/03/环形温度调节实现/">环形温度调节实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/03/ vue-组件封装中之slot插槽使用/">vue---组件封装中之slot插槽使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/03/PHP获取微信小程序码/">微信小程序---PHP获取微信小程序码</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/03/微信小程序合成海报/">微信小程序---合成海报分享到朋友圈</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/24/单点登录配置 记录/">配置webgate拦截跳转到ldap登录页实现单点登录</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/23/一次环境升级记录/">一次lnmp环境升级记录</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/03/yum源的代理设置及修改/">yum源的代理设置及修改</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/23/脚本微博登录自动发微博并返回cookie/">脚本微博登录自动发微博并返回cookie</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/10/scrapy爬虫之初次尝试/">scrapy爬虫之初次尝试</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/26/安装python的crypto模块/">安装python的crypto模块</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://hexo.io" title="Hexo" target="_blank">Hexo</a><ul></ul><a href="http://moxfive.xyz/" title="MOxFIVE" target="_blank">MOxFIVE</a><ul></ul><a href="https://coolshell.cn/" title="左耳朵耗子的酷壳" target="_blank">左耳朵耗子的酷壳</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">MagicYou.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.3.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.3.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.3.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.3.0"></script></div></body></html>